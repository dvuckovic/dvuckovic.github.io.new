(window.webpackJsonp=window.webpackJsonp||[]).push([[140],{1310:function(e,t,a){"use strict";a.r(t);var s=a(9),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("In my corporate workplace we have a dedicated ADSL line for the Windows® mail server. As all connections go it’s a little buggy, so every now and then ADSL router locks up, mails stop flowing and the only thing that helps is the manual reboot of the router. Since this seems to happen only on the weekends and other non-working hours (Murphy’s Law?), the need arose for an automated solution to this problem.")]),e._v(" "),a("p",[e._v("My initial idea was for a small command line program that pings a server and takes an action if the ping fails. This is relatively easy to do, and since there are Scheduled Tasks available on the Windows® system, you can set this program to auto execute on some reasonable time interval.")]),e._v(" "),a("p",[e._v("Since this is only going to be used on Windows®, I decided that MS-DOS® Batch script should do the trick. Ping is already available in shell access (ping), and you can find plethora of different programs to help you make a normal HTTP request from the command line (e.g. wget, curl). Almost all routers nowadays have web-based administration interface, so, in theory, you can always simulate user rebooting the router by sending appropriate requests. Granted, some of these are more complex than others and may require sending a variable or two along with the request. One thing that always helped me when trying to figure out the correct sequence of events in these circumstances was Mozilla Firefox®.")]),e._v(" "),a("p",[e._v("Firefox® has several mind blowing add-ons/plugins, one of them being "),a("a",{attrs:{href:"http://livehttpheaders.mozdev.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Live HTTP Headers"),a("OutboundLink")],1),e._v(". Using it while rebooting the router in browser you can inspect all the requests interface makes in order to accomplish this: all the correct URIs, variables, etc. Also, it may help by looking at the source code of the page with the Reboot button: note the action in the FORM containing the button, almost always it is the correct URL of the page that process the request.")]),e._v(" "),a("p",[e._v("So, let’s take a look at "),a("a",{attrs:{href:"https://cdn.dvuckovic.com/downloads/internet-checker.bat",target:"_blank",rel:"noopener noreferrer"}},[e._v("the script itself"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v('First, we turn off any unnecessary "echoes" of our commands (old friend of all DOS batch scripters):')]),e._v(" "),a("div",{staticClass:"language-batch extra-class"},[a("pre",{pre:!0,attrs:{class:"language-batch"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("@")]),a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("echo")]),e._v(" off")]),e._v("\n")])])]),a("p",[e._v("Then we ping the most reliable server which we can find (I use Google, but that "),a("a",{attrs:{href:"http://techcrunch.com/2009/05/14/googles-gets-its-own-fail-whale/",target:"_blank",rel:"noopener noreferrer"}},[e._v("might not be good idea"),a("OutboundLink")],1),e._v("):")]),e._v(" "),a("div",{staticClass:"language-batch extra-class"},[a("pre",{pre:!0,attrs:{class:"language-batch"}},[a("code",[a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ping")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("-n")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v(" www.google.com|find "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/i")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Received = 1"')]),e._v(" > NUL")]),e._v("\n")])])]),a("p",[e._v('Note the "pipe" ('),a("code",[e._v("|")]),e._v(") operator which pipes the output of the first command to the input of the second one. ping first sends a single ICMP packet to www.google.com. "),a("code",[e._v("find")]),e._v(' command then searches the output of ping for "Received = 1" string, and compares the result. For IFTHEN clause we will be using a check of the ErrorLevel, which gets raised if an error has occurred:')]),e._v(" "),a("div",{staticClass:"language-batch extra-class"},[a("pre",{pre:!0,attrs:{class:"language-batch"}},[a("code",[a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("not")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ErrorLevel")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("goto")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token label property"}},[e._v(":WORKS")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("else")])]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("goto")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token label property"}},[e._v(":DOESNTWORK")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),a("p",[a("code",[e._v("goto")]),e._v(" commands use labels to redirect the flow of the script. So if no error was raised during the last compare (e.g. ICMP packet was successfully returned), script will execute all code under the :WORKS label:")]),e._v(" "),a("div",{staticClass:"language-batch extra-class"},[a("pre",{pre:!0,attrs:{class:"language-batch"}},[a("code",[a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("eventcreate")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/l")]),e._v(" System "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/t")]),e._v(" INFORMATION "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/so")]),e._v(" internet-checker "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/id")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("200")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/d")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Internet OK, proceeding normally..."')])]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("goto")]),e._v(" end")]),e._v("\n")])])]),a("p",[e._v("Here we will log the check as successful to the Windows Event Log, in order to keep track when the check has occurred. "),a("code",[e._v("eventcreate")]),e._v(" command helps us achieve that, by logging our event to the System log, as a type of Information, with an ID of 200 (any ID from 1 through 1000 will do).")]),e._v(" "),a("p",[e._v("In case there was a problem with a "),a("code",[e._v("ping")]),e._v(" packet, and error was raised, code under the second label would be executed:")]),e._v(" "),a("div",{staticClass:"language-batch extra-class"},[a("pre",{pre:!0,attrs:{class:"language-batch"}},[a("code",[a("span",{pre:!0,attrs:{class:"token label property"}},[e._v(":DOESNTWORK")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("eventcreate")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/l")]),e._v(" System "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/t")]),e._v(" ERROR "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/so")]),e._v(" internet-checker "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/id")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("500")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/d")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Internet down, rebooting router..."')])]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v(":: START CURL EXECUTION")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v(":: FOR WEBSTAR CABLE MODEM")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v(':: curl -d "ResetToFactory=3" -d "RestoreFactoryYes=1" http://192.168.100.1/goform/reset')]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v(":: FOR TPLINK CABLE ROUTER")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v(':: curl -D - -s -u "user:pass" "http://192.168.1.1/userRpm/SysRebootRpm.htm?Reboot=Reboot"')]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v(":: FOR TPLINK ADSL ROUTER")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("curl")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("-D")]),e._v(" - "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("-s")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("-u")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"user:pass"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"http://192.168.0.3/rebootinfo.cgi"')])]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v(":: END CURL EXECUTION")]),e._v("\n")])])]),a("p",[e._v("First, we log an Event, but a different one, of type Error, and with an ID of 500. Then we turn to the curl program and execute a request which will result in router reboot. As you can see there are numerous options for this, and these are just some cases I stumbled upon. I’d liked to keep them all in case I would need to refactor this script for a different use (I will just uncomment them by removing "),a("code",[e._v("::")]),e._v("). Take a closer look at the last curl command: switch "),a("code",[e._v("-u")]),e._v(' sends a "user:pass" combination, because '),a("code",[e._v("curl")]),e._v(" must be able to make proper HTTP authorization in order to use the script.")]),e._v(" "),a("p",[e._v("There are some caveats in this whole DOS batch approach:")]),e._v(" "),a("ul",[a("li",[e._v("storing user/pass combination plain like this in a text script is a little bit sensitive, but it beats the hell out of need to manually enter the password when prompted (not a particularly efficient for an automated solution).")]),e._v(" "),a("li",[a("code",[e._v("eventcreate")]),e._v(" command produces an output which confirms that an event was logged, and this is difficult to avoid (there is no "),a("code",[e._v("/quiet")]),e._v(" switch here).")]),e._v(" "),a("li",[e._v("also, a brief command prompt window would appear if the program was called from GUI.")])]),e._v(" "),a("p",[e._v('So, how to address these issues? Well, there is a small program which can "compile" your DOS batch script to an .EXE file, with a few added bonuses. The program name is '),a("a",{attrs:{href:"http://www.f2ko.de/programs.php?lang=en&pid=b2e",target:"_blank",rel:"noopener noreferrer"}},[e._v("Bat To Exe Converter"),a("OutboundLink")],1),e._v(" and it’s freeware.")]),e._v(" "),a("p",[e._v('Compiled programs are difficult to decompose, so user/pass combination for your router will probably be safe. There is also an option to encrypt the .EXE file, which is even safer. Then, there is an option to make the new application "invisible", e.g. there would be no pop up window, no output, nothing! That’s 3 of 3.')]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.dvuckovic.com/posts/internet-checker-bat2exe.jpg#nozoom",alt:"Bat To Exe Converter"}})]),e._v(" "),a("p",[e._v("Now let’s go over bonuses:")]),e._v(" "),a("ul",[a("li",[e._v("there is an option to include all external programs and extract them on runtime, along with deleting the files when done with them (here you can include curl and its DLLs.")]),e._v(" "),a("li",[e._v("you can add an icon to the .EXE file and make all thing much more serious 😃")]),e._v(" "),a("li",[e._v("programs allows you to embed .EXE manifest, too")])]),e._v(" "),a("p",[e._v("I was sold when I tried all this, and a final .EXE file was made. I will not be sharing it, because of the obvious reasons (I doubt someone else has this same user/pass combination on their router, on the same address nevertheless). So feel free to adapt the .BAT script and compile it.")]),e._v(" "),a("p",[e._v("In order to schedule the task for repetitive invocation, you can use following command:")]),e._v(" "),a("div",{staticClass:"language-batch extra-class"},[a("pre",{pre:!0,attrs:{class:"language-batch"}},[a("code",[a("span",{pre:!0,attrs:{class:"token command"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("C")]),a("span",{pre:!0,attrs:{class:"token label property"}},[e._v(":\\>schtasks")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/create")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/sc")]),e._v(" minute "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/mo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("30")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/tn")]),e._v(" internet-checker "),a("span",{pre:!0,attrs:{class:"token parameter attr-name"}},[e._v("/tr")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"c:\\internet-checker.exe"')])]),e._v("\n")])])]),a("p",[e._v("It will create a task that runs our app on every 30 minutes (be sure to supply correct path!). Too much, too little? Adjust where necessary.")]),e._v(" "),a("p",[e._v("That’s it! Just be sure to check Event Log now and then to be sure you’re running the script ("),a("code",[e._v("eventvwr")]),e._v(" opens up dedicated MMC window).")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.dvuckovic.com/posts/internet-checker-dos.jpg#nozoom",alt:"Bat To Exe Converter"}})])])}),[],!1,null,null,null);t.default=r.exports}}]);